# 開発設計ドキュメント（TDD 駆動・個人開発）

このドキュメントは、開発を迷いなく進めるための単一の参照点。AI/人間どちらが実装しても同じ品質に収束するよう、アーキから設計原則、命名、テスト、運用までを一貫して定義する。

## 目的 / スコープ

- **目的**: 要求定義と機能要件を、実装可能な設計と具体的なルールに落とし込む。
- **対象**: Web/モバイル Web（Next.js/TypeScript 前提で記述。置き換え可）。
- **参照**: `プロジェクト/要求定義.md`, `プロジェクト/機能要件.md`

## 原則（Opinion）

- **単方向依存**: presentation → application → domain → infrastructure。外 → 内のみ依存 OK。
- **DTO と Domain を分離**: I/O 境界では DTO、アプリ内部では不変 Domain モデル。
- **失敗を型で表現**: 戻り値は`Result<T, E>`または例外を Error Map で吸収し必ず統一。
- **TDD ファースト**: 失敗するテスト → 実装 → リファクタの順を小さく回す。
- **コントラクト駆動**: API/型/エラーフォーマットを先に決めてから実装。

## 目次

1. アーキテクチャ設計（01_architecture_design）
2. DB 設計（02_database_design）
3. API 設計（03_api_design）
4. 画面/遷移/SEO（04_screen_transition_design / 05_seo_requirements）
5. エラーハンドリング/型定義（06_error_handling_design / 07_type_definitions）
6. 開発セットアップ/テスト戦略/フロントエンド設計（08/09/10）
7. CI/CD / E2E（11/12）
8. セキュリティ / パフォーマンス（13/14/15）
9. デザインシステム（00〜04）
10. ライブラリ対策（shadcn / supabase / nextjs）

---

## 1. アーキテクチャ設計（01_architecture_design）

- **層構造**
  - presentation: Next.js App Router（`app/`）・UI・RSC/Client の境界管理
  - application: use-case・service（副作用のオーケストレーション）
  - domain: entity/value-object/aggregate（ビジネスルールの中心。不変/純粋）
  - infrastructure: DB/外部 API/FS/キャッシュ実装
- **依存ルール**: presentation→application→domain。infrastructure は domain に依存可だが、参照は port/interface 経由。
- **ディレクトリ指針（例）**
  - `src/domain/*`（`entities/`, `value-objects/`, `repositories/ports.ts`）
  - `src/application/*`（`use-cases/`, `services/`）
  - `src/infrastructure/*`（`prisma/`, `supabase/`, `adapters/`）
  - `src/presentation/*`（`app/`, `components/`, `features/`）
- **横断関心**: `src/shared/`に`logger`, `config`, `result`, `errors`, `utils` を配置。

## 2. DB 設計（02_database_design）

- **RDB 想定**: PostgreSQL。
- **命名**: テーブル/列は`snake_case`、複数形テーブル。FK は`<referenced>_id`。
- **主キー**: `uuid`（v7/ULID 推奨）。
- **共通カラム**: `id`, `created_at`, `updated_at`, `deleted_at(NULL=not deleted)`。
- **制約/整合性**: NOT NULL・FK ON UPDATE/DELETE、CHECK でドメイン制約。
- **インデックス方針**: 参照頻度の高い検索キーに B-Tree、時系列には複合索引（例：`user_id, created_at`）。
- **マイグレーション**: 1PR=1 マイグレーション。後方互換 → デプロイ → 切替 → クリーンアップの順。
- **ERD**: `/プロジェクト/設計/erd.drawio`（追って作成）。

## 3. API 設計（03_api_design）

- **ベース**: REST `/api/v1/*`。リソースは複数形・kebab-case。
- **JSON 規約**: フィールドは`camelCase`。日時は ISO8601（UTC）。
- **成功レスポンス**

```json
{
  "success": true,
  "data": {},
  "meta": { "traceId": "...", "pagination": { "nextCursor": null } }
}
```

- **エラーレスポンス**

```json
{
  "success": false,
  "error": { "code": "VALIDATION_ERROR", "message": "...", "details": {} },
  "traceId": "..."
}
```

- **HTTP ステータス**: 2xx 成功、4xx クライアント、5xx サーバー。ビジネスエラーは 409/422。
- **ページネーション**: カーソル方式 `?cursor=xxx&limit=20`。`meta.pagination.nextCursor` を返却。
- **Idempotency**: 重要作成系は`Idempotency-Key`を受け取り再実行耐性。
- **認可**: JWT/セッションから`subject`を解決。権限は use-case 内で検証。

## 4. 画面遷移設計（04_screen_transition_design）

- 画面一覧と遷移有向グラフを Figma/Mermaid で管理。
- 各画面に必要権限/データ依存/ローディング/空状態/エラー状態を定義。
- 戻る/深いリンク/共有 URL の振る舞いを規定。

## 5. SEO 要件（05_seo_requirements）

- `title/description/canonical` を必ず設定。OGP/Twitter Card 画像の自動生成。
- 構造化データ（JSON-LD）: Breadcrumb / Article / WebSite。
- サイトマップと`robots.txt`自動生成。国際化時は`hreflang`。
- CLS/LCP/INP を意識した遅延読み込みとプレースホルダ。

## 6. エラーハンドリング設計（06_error_handling_design）

- **分類**: Validation / Auth / Permission / NotFound / Conflict / System。
- **ログレベル**: validation=warn, auth=info, system=error。PII はマスク。
- **再試行**: 外部 I/O は指数バックオフ。致命的なものはサーキットブレーカ。
- **ユーザー表示**: ユーザー向け文言は`i18n`キーで管理。技術詳細は非表示。

## 7. 型定義（07_type_definitions）

- `src/types/`に共有型。API の I/O は`zod`スキーマで定義し型を生成。
- Domain 型は不変・メソッド持たせず純粋データ＋ロジックは関数に切り出し。
- DTO↔Domain のマッパーを`src/application/mappers/`に集約。

## 8. 開発セットアップ（08_development_setup）

- Node LTS, pnpm, Docker（DB）。`.env.example`を配布し`pnpm setup`で初期化。
- コミット規約: Conventional Commits。PR は必須、1PR は小さく。
- 静的解析: typecheck, lint, format をプリプッシュで実行。

## 9. テスト戦略（09_test_strategy）

- **ピラミッド**: Unit(70) / Integration(20) / E2E(10)。
- **TDD**: 失敗テスト → 最小実装 → リファクタ。外部 I/O はポートをモック。
- Unit: 純粋関数とドメインロジック。Integration: リポジトリ/HTTP。E2E: クリティカルフロー。
- カバレッジ目標: 行 80%/分岐 70%。スナップショット乱用しない。

## 10. フロントエンド設計（10_frontend_design）

- **分類**: `ui`（再利用可能・状態なし）/ `features`（ユースケース単位）/ `layouts`。
- **状態管理**: サーバー状態は`fetcher + cache`（SWR/React Query 等）に集約。ローカルは`useState`/`useReducer`。
- **RSC/Client**: データ取得は原則 RSC。インタラクションは Client で島化。
- **Props 方針**: 必須最小・意味名・Union 型で分岐を型安全に。アクセシビリティは必須。

## 11. CI/CD 設計（11_cicd_design）

- PR で `typecheck/lint/test/build` を並列実行。main にマージで自動デプロイ。
- 環境: preview（PR）、staging、production。シークレットは OIDC/Secret Manager。
- リリース: セマンティックリリースでバージョン/CHANGELOG 自動化。

## 12. E2E テスト設計（12_e2e_test_design）

- クリティカルパス例（エフェメラル・ダイアリー）
  - サインイン → エントリー作成（色+一言）→ タイムライン表示
  - カレンダー表示 → 日付選択 → 詳細表示
  - 「去年の今日」を開く → 該当エントリー表示
- データ用フィクスチャは API 経由で作成/破棄。テストは並列安全に。

## 13. セキュリティ設計（13_security_design）

- 認証/認可: セッション orJWT。ルートガードとサーバー側検証の二重化。
- 入力検証: すべての I/O で`zod`。ファイルサイズ/種類制限。画像はサニタイズ。
- ヘッダ/CSP: `X-Content-Type-Options`, `Referrer-Policy`, 厳格`CSP`。
- レート制限と監査ログ。秘密情報はログに残さない。

## 14. パフォーマンス最適化（14_performance_optimization）

- 画像最適化（自動リサイズ/WebP/AVIF）、クリティカル CSS、コード分割。
- キャッシュ戦略: RSC で`revalidate`設計。API は CDN/ETag/Cache-Control。
- 目標: CWV LCP<2.5s, INP<200ms, CLS<0.1。

## 15. パフォーマンス監視（15_performance_monitoring）

- RUM（Web Vitals 送信）、APM（遅延・エラー率）、エラートラッキング（Sentry 等）。
- ダッシュボードを用意し SLO を可視化。回帰は CI で検知。

## 16. デザインシステム（00〜04）

- 00_basic_design: 導入/トークン/使い方。
- 01_design_principles: カラー/タイポ/スペーシング（例: プライマリ `#3B82F6`）。
- 02_component_design: ボタン/カード/フォーム等のバリエーションと使用条件。
- 03_animation_system: 時間・イージング・トランジションの規約。
- 04_layout_system: グリッド/ブレークポイント/最大幅。

## 17. ライブラリ対策

- shadcn: よく使うコンポーネントのレシピ・アンチパターン集。
- supabase: auth/storage のテストセットアップ（モック・ローカルエミュレータ）。
- nextjs app router: Server/Client の使い分け、データフェッチ/エラー処理パターン。

## 付録 A. 命名と規約

- ファイル: `kebab-case.tsx`、型は`PascalCase`、変数/プロパティは`camelCase`。
- コミット: `feat: ~`, `fix: ~`, `refactor: ~`, `test: ~`, `chore: ~`。
- ドキュメント粒度: 仕様変更は本書を更新 →PR レビュー → 合意。

---

このドキュメントは生き物。変更は PR で議論して常に最新へ。迷ったらここに追記してから実装する。
